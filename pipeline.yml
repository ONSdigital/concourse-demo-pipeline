resource_types:
- name: concourse-git-semver-tag
  type: docker-image
  source:
    repository: laurentverbruggen/concourse-git-semver-tag-resource

- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource

- name: artifactory
  type: docker-image
  source:
    repository: pivotalservices/artifactory-resource

resources:
- name: acceptance-tests
  type: git
  source: {uri: "https://github.com/ONSdigital/concourse-demo-acceptance-tests"}

- name: python-service
  type: git
  source: {uri: "https://github.com/ONSdigital/concourse-demo-python-service"}

- name: java-service
  type: git
  source: {uri: "https://github.com/ONSdigital/concourse-demo-java-service"}

- name: notifications
  type: git
  source: {uri: "https://github.com/ONSdigital/concourse-demo-notifications"}

- name: preprod-deploy-trigger
  type: git
  source:
    uri: "git@github.com:ONSdigital/concourse-demo-deploy-trigger"
    paths: ["preprod/*"]
    private_key: ((github_key))

- name: prod-deploy-trigger
  type: git
  source:
    uri: "git@github.com:ONSdigital/concourse-demo-deploy-trigger"
    paths: ["prod/*"]
    private_key: ((github_key))

- name: python-tag
  type: concourse-git-semver-tag
  source:
    uri: git@github.com:ONSdigital/concourse-demo-python-service.git
    private_key: ((github_key))
    branch: master

- name: java-tag
  type: concourse-git-semver-tag
  source:
    uri: git@github.com:ONSdigital/concourse-demo-java-service.git
    private_key: ((github_key))
    branch: master

- name: cf-resource-ci
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: ci
    skip_cert_check: true

- name: cf-resource-int
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: int
    skip_cert_check: true

- name: cf-resource-sit
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: sit
    skip_cert_check: true

- name: cf-resource-cat
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: cat
    skip_cert_check: true

- name: notify
  type: slack-notification
  source:
    url: ((slack-webhook))

- name: file-repository
  type: artifactory
  source:
    endpoint: http://artifactory.rmdev.onsdigital.uk/artifactory
    repository: "/libs-release-local/uk/gov/ons/ctp/product/"
    regex: "concourse_demo_service-(?<version>.*).jar"
    username: ((artifactory_username))
    password: ((artifactory_password))
    skip_ssl_verification: true

jobs:
- name: python-unit-tests
  plan: 
  - get: python-service
    trigger: true
  - task: run-unit-tests
    file: python-service/ci/task.yml

- name: java-unit-tests
  plan:
  - get: java-service
    trigger: true
  - task: run-unit-tests
    file: java-service/ci/task.yml

- name: deploy-python-demo-ci
  serial_groups: [deploy-python-demo-ci]
  plan:
  - get: python-service
    trigger: true
    passed: [python-unit-tests]
  - put: cf-resource-ci
    params:
      environment_variables:
        ANIMAL_SERVICE: "http://concourse-demo-java-service-ci.apps.devtest.onsclofo.uk"
      manifest: python-service/manifest.yml
      path: python-service
      current_app_name: concourse-demo-python-service-ci

- name: deploy-java-demo-ci
  serial_groups: [deploy-java-demo-ci]
  plan:
  - get: java-service
    trigger: true
    passed: [java-unit-tests]
  - task: run-build
    file: java-service/ci/task.yml
  - put: cf-resource-ci
    params:
      manifest: java-service/manifest.yml
      path: artifacts/*.jar
      current_app_name: concourse-demo-java-service-ci

- name: acceptance-tests
  serial_groups: [deploy-python-demo-ci, deploy-java-demo-ci]
  plan:
  - get: acceptance-tests
    trigger: true
  - get: python-service
    passed: [deploy-python-demo-ci]
    trigger: true
  - get: java-service
    passed: [deploy-java-demo-ci]
    trigger: true
  - task: run-acceptance-tests
    on_failure:
      put: notify
      params:
        text: "Acceptance test failed"
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: acceptance-tests
      params:
        ENDPOINT: 'http://concourse-demo-python-service-ci.apps.devtest.onsclofo.uk'
      run:
        path: sh
        dir: acceptance-tests
        args:
        - -exc
        - |
          pipenv install
          pipenv run behave

- name: deploy-python-demo-int
  serial_groups: [deploy-python-demo-int]
  plan:
  - get: python-service
    passed: [acceptance-tests]
    trigger: true
  - put: cf-resource-int
    params:
      environment_variables:
        ANIMAL_SERVICE: "http://concourse-demo-java-service-int.apps.devtest.onsclofo.uk"
      manifest: python-service/manifest.yml
      path: python-service
      current_app_name: concourse-demo-python-service-int

- name: deploy-java-demo-int
  serial_groups: [deploy-java-demo-int]
  plan:
  - get: java-service
    trigger: true
    passed: [acceptance-tests]
  - task: run-build
    file: java-service/ci/task.yml
  - put: cf-resource-int
    params:
      manifest: java-service/manifest.yml
      path: artifacts/*.jar
      current_app_name: concourse-demo-java-service-int

- name: int-smoke-tests
  serial_groups: [deploy-python-demo-int, deploy-java-demo-int]
  plan:
  - get: acceptance-tests
    trigger: true
  - get: python-service
    passed: [deploy-python-demo-int]
    trigger: true
  - get: java-service
    passed: [deploy-java-demo-int]
    trigger: true
  - task: run-int-smoke-tests
    on_failure:
      put: notify
      params:
        text: "Int smoke test failed"
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: acceptance-tests
      params:
        ENDPOINT: 'http://concourse-demo-python-service-int.apps.devtest.onsclofo.uk'
      run:
        path: sh
        dir: acceptance-tests
        args:
        - -exc
        - |
          pipenv install
          pipenv run behave

- name: preprod-trigger
  disable_manual_trigger: true
  plan:
  - get: python-service
    passed: [int-smoke-tests]
  - get: java-service
    passed: [int-smoke-tests]
  - get: preprod-deploy-trigger
    trigger: true

- name: deploy-python-demo-preprod
  disable_manual_trigger: true
  serial_groups: [deploy-python-demo-preprod]
  plan:
  - get: python-service
    trigger: true
    passed: [preprod-trigger]
  - get: notifications
  - task: run-build
    file: python-service/ci/task.yml
  - put: python-tag
    params: {bump: minor}
  - task: release-notes
    file: notifications/ci/task.yml
    params:
      SLACK_HOOK: ((slack_webhook))
      REPO_NAME: concourse-demo-python-service
  - put: cf-resource-sit
    params:
      environment_variables:
        ANIMAL_SERVICE: "http://concourse-demo-java-service-sit.apps.devtest.onsclofo.uk"
      manifest: python-service/manifest.yml
      path: python-service
      current_app_name: concourse-demo-python-service-preprod

- name: deploy-java-demo-preprod
  disable_manual_trigger: true
  serial_groups: [deploy-java-demo-preprod]
  plan:
  - get: java-service
    trigger: true
    passed: [preprod-trigger]
  - get: notifications
  - task: run-build
    file: java-service/ci/task.yml
  - put: java-tag
    params: {bump: minor}
  - task: release-notes
    file: notifications/ci/task.yml
    params:
      SLACK_HOOK: ((slack_webhook))
      REPO_NAME: concourse-demo-java-service
  - put: file-repository
    params: {file: "artifacts/*.jar"}
  - put: cf-resource-sit
    params:
      manifest: java-service/manifest.yml
      path: artifacts/*.jar
      current_app_name: concourse-demo-java-service-sit

- name: preprod-smoke-tests
  serial_groups: [deploy-python-demo-preprod, deploy-java-demo-preprod]
  plan:
  - get: acceptance-tests
    trigger: true
  - get: python-service
    passed: [deploy-python-demo-preprod]
    trigger: true
  - get: java-service
    passed: [deploy-java-demo-preprod]
    trigger: true
  - task: run-preprod-smoke-tests
    on_failure:
      put: notify
      params:
        text: "Preprod smoke test failed"
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: acceptance-tests
      params:
        ENDPOINT: 'http://concourse-demo-python-service-preprod.apps.devtest.onsclofo.uk'
      run:
        path: sh
        dir: acceptance-tests
        args:
        - -exc
        - |
          pipenv install
          pipenv run behave

- name: prod-trigger
  disable_manual_trigger: true
  plan:
  - get: python-service
    passed: [preprod-smoke-tests]
  - get: java-service
    passed: [preprod-smoke-tests]
  - get: prod-deploy-trigger
    trigger: true

- name: deploy-python-demo-prod
  disable_manual_trigger: true
  serial_groups: [deploy-python-demo-prod]
  plan:
  - get: python-service
    trigger: true
    passed: [prod-trigger]
  - put: cf-resource-cat
    params:
      environment_variables:
        ANIMAL_SERVICE: "http://concourse-demo-java-service-prod.apps.devtest.onsclofo.uk"
      manifest: python-service/manifest.yml
      path: python-service
      current_app_name: concourse-demo-python-service-prod

- name: deploy-java-demo-prod
  disable_manual_trigger: true
  serial_groups: [deploy-java-demo-prod]
  plan:
  - get: java-service
    trigger: true
    passed: [prod-trigger]
  - get: file-repository
    passed: [deploy-java-demo-preprod]
  - get: prod-deploy-trigger
    trigger: true
  - put: cf-resource-cat
    params:
      manifest: java-service/manifest.yml
      path: file-repository/*.jar
      current_app_name: concourse-demo-java-service-prod

- name: prod-smoke-tests
  serial_groups: [deploy-python-demo-prod, deploy-java-demo-prod]
  plan:
  - get: acceptance-tests
    trigger: true
  - get: python-service
    passed: [deploy-python-demo-prod]
    trigger: true
  - get: java-service
    passed: [deploy-java-demo-prod]
    trigger: true
  - task: run-prod-smoke-tests
    on_failure:
      put: notify
      params:
        text: "Prod smoke test failed"
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: acceptance-tests
      params:
        ENDPOINT: 'http://concourse-demo-python-service-prod.apps.devtest.onsclofo.uk'
      run:
        path: sh
        dir: acceptance-tests
        args:
        - -exc
        - |
          pipenv install
          pipenv run behave